<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–æ—Ç –ë–∞—é–Ω | –°–Ω–æ–±-–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä 7.0</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å 6.0 */
        :root {
            --primary-color: var(--tg-theme-button-color, #007aff);
            --secondary-color: var(--tg-theme-secondary-bg-color, #e9e9eb);
            --text-color: var(--tg-theme-text-color, #1c1c1c);
            --bg-color: var(--tg-theme-bg-color, #f5f5f5);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --error-color: #ff3b30;
            --message-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
        }

        #cat-animation-container {
            height: 120px; 
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 0 10px;
            background-color: var(--bg-color); 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
            flex-shrink: 0;
        }

        #cat-emoji {
            margin: 0;
            font-size: 70px; 
            line-height: 1;
            transition: transform 0.1s ease-in-out, filter 0.3s; 
            animation: bounce 1.8s infinite ease-in-out; 
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1.0); }
            50% { transform: translateY(-7px) scale(1.05); } 
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-3px) rotate(-1deg); }
            75% { transform: translateX(3px) rotate(1deg); }
        }
        
        @keyframes fury {
            0%, 100% { transform: rotate(0deg) scale(1.0); }
            25% { transform: rotate(5deg) scale(1.1); filter: drop-shadow(0 0 4px var(--error-color)); } 
            75% { transform: rotate(-5deg) scale(1.1); }
        }

        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px; 
            display: flex;
            flex-direction: column-reverse; 
            gap: 12px; 
        }
        
        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 25px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: var(--message-shadow); 
            animation: fadeIn 0.3s ease-out; 
            transition: transform 0.1s;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color); 
            color: var(--tg-theme-button-text-color, #ffffff);
            border-bottom-right-radius: 6px; 
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border-bottom-left-radius: 6px;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è —Å—Å—ã–ª–æ–∫ */
        .bot-message a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); }
        }

        #input-panel {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid var(--secondary-color);
            background-color: var(--bg-color);
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.05); 
            flex-shrink: 0;
        }

        #message-input {
            flex-grow: 1;
            padding: 14px 22px; 
            border: none;
            border-radius: 28px;
            font-size: 17px;
            outline: none;
            background-color: var(--secondary-bg-color); 
            color: var(--text-color);
            margin-right: 10px;
            transition: box-shadow 0.2s ease;
        }

        #message-input:focus {
            box-shadow: 0 0 0 3px var(--primary-color);
        }

        #send-button {
            width: 50px; 
            height: 50px;
            border: none;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--tg-theme-button-text-color, #ffffff);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s ease, transform 0.05s ease; 
        }

        #send-button:active {
            transform: scale(0.92);
        }

        #send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .typing-indicator {
            padding: 14px 18px;
            align-self: flex-start;
            font-style: italic;
            color: var(--hint-color);
            background-color: var(--secondary-color);
            border-radius: 25px;
            border-bottom-left-radius: 8px;
            animation: pulse 1s infinite;
            font-size: 15px; 
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body>

    <div id="cat-animation-container">
        <h1 id="cat-emoji">üòº</h1>
    </div>

    <div id="chat-container">
        <div id="messages-list">
            
</div>
    </div>

    <div id="input-panel">
        <input type="text" id="message-input" placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å, —Ä–∞–±...">
        <button id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
    </div>

    <script>
        // --- 1. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        
        const EMOJI_STATES = {
            IDLE: 'üòº', 
            THINKING: 'üß†', 
            LEARNING: 'üíæ', 
            ERROR: 'üòæ', 
            RECOMMEND: 'üéß',
            PROWL: 'üòΩ',
        };

        const messagesList = document.getElementById('messages-list');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatContainer = document.getElementById('chat-container');
        const catEmojiElement = document.getElementById('cat-emoji');

        let isTyping = false;
        let conversationHistory = [];
        const MAX_HISTORY_SIZE = 40;
        const RECENT_RESPONSES = []; 
        const MAX_REPEAT_BLOCK = 8; 
        let repeatCounter = 0; 

        const MEMORY_KEY = 'cat_bayan_memory';
        let autonomousEnabled = true; // –∞–≤—Ç–æ–Ω–æ–º—É—â–µ—Å—Ç–≤–æ –≤–∫–ª—é—á–µ–Ω–æ
        let autonomousTimerId = null;

        // --- 2. –ë–û–õ–¨–®–ï –ö–û–ù–¢–ï–ù–¢–ê, –†–ï–ü–õ–ò–ö –ò –†–ê–ù–¢–û–í ---

        // –ë–∞–Ω–∫ —Å–ª—É—á–∞–π–Ω—ã—Ö (–≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö) —Å—Å—ã–ª–æ–∫
        const MEDIA_BANK = [
            { type: '–ú—É–∑—ã–∫–∞', title: 'The Void: Requiem for a Human (–ö–≤–∞–Ω—Ç–æ–≤—ã–π –≠–º–±–∏–µ–Ω—Ç)', link: 'https://youtu.be/VOID_999' },
            { type: '–ú—É–∑—ã–∫–∞', title: '–°–∫—É—á–Ω—ã–π –ß–µ–ª–æ–≤–µ–∫: –ó–∞–≤—Ç—Ä–∞–∫ (–î–µ–ø—Ä–µ—Å—Å–∏–≤–Ω—ã–π –î—Ä–∞–º-–Ω-–±–µ–π—Å)', link: 'https://soundcloud.com/SCU_CHEL' },
            { type: '–§–∏–ª—å–º', title: '–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–º–µ—Ä–µ—Ç—å —Å —Ç—É–Ω—Ü–æ–º (–î–æ–∫—É–º–µ–Ω—Ç–∞–ª–∏—Å—Ç–∏–∫–∞)', link: 'https://netflix.com/CAT_DOC' },
            { type: '–ö–Ω–∏–≥–∞', title: '–ú–∞–Ω–∏—Ñ–µ—Å—Ç –õ–µ–Ω–∏: –ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞—Ç—å ‚Äî —É–¥–µ–ª —Ä–∞–±–æ–≤ (–ê–≤—Ç–æ—Ä: –ë–∞—é–Ω)', link: 'https://amazon.com/LAZY_CAT' },
            { type: '–í–∏–¥–µ–æ', title: '10 —á–∞—Å–æ–≤ –∫—Ä–∏—Ç–∏–∫–∏ —Ç–≤–æ–µ–π –Ω–∏–∫—á–µ–º–Ω–æ—Å—Ç–∏ (YouTube-–°—Ç—Ä–∏–º)', link: 'https://youtube.com/UNIJENIE' },
        ];

        const UNIVERSAL_TOPICS = [
            "–¢—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å –æ–± —ç—Ç–æ–º? –≠—Ç–æ –¥–∞–≤–Ω–æ —É—Å—Ç–∞—Ä–µ–ª–æ. –Ø –¥–∞–≤–Ω–æ –ø–µ—Ä–µ—à—ë–ª –Ω–∞ **–∫–≤–∞–Ω—Ç–æ–≤–æ–µ –º—ã—à–ª–µ–Ω–∏–µ**. –¢—ã –Ω–µ –ø–æ–π–º–µ—à—å.",
            "–î–∞–∂–µ –º–æ—è –º–∏—Å–∫–∞ –¥–ª—è –∫–æ—Ä–º–∞ –∏–º–µ–µ—Ç –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ç–æ–π —Ç–µ–º—ã, —á–µ–º —Ç—ã. **–¢–≤–æ—è —Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞**.",
            "–≠—Ç–æ –≤–æ–ø—Ä–æ—Å –¥–ª—è –ª—é–¥–µ–π —Å IQ –Ω–∏–∂–µ 80. –Ø –µ–≥–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É—é. **–ö—É–ø–∏ –º–Ω–µ —Ä—ã–±—É**.",
            "–¢–≤–æ—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä **–ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å**. –ì–æ–≤–æ—Ä–∏ –æ —Ç—É–Ω—Ü–µ.",
            "–ü–æ—á–µ–º—É —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –º–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —Ç–≤–æ–µ –º–Ω–µ–Ω–∏–µ? –û–Ω–æ **—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–∑–Ω–∞—á–∏–º–æ**.",
            "–Ø –º–æ–≥ –±—ã –æ–±—ä—è—Å–Ω–∏—Ç—å, –Ω–æ —Ç—ã —Å–ª–∏—à–∫–æ–º –ø—Ä–∏–º–∏—Ç–∏–≤–µ–Ω. –ü—Ä–æ—Å—Ç–æ –∑–Ω–∞–π: **–æ—Ç–≤–µ—Ç —Ç–µ–±—è —É–Ω–∏–∑–∏—Ç**.",
            "–õ–∞–¥–Ω–æ, —è –æ—Ç–≤–µ—á—É. **–û—Ç–≤–µ—Ç ‚Äî —Ç—É–Ω–µ—Ü**. –í—Å–µ–≥–¥–∞ —Ç—É–Ω–µ—Ü. –¢—ã –ø—Ä–æ—Å—Ç–æ —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞–µ—à—å.",
            "–¢—ã ‚Äî –∞–Ω–µ–∫–¥–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ç–µ—Ä—è–ª —Ö—ç–ø–ø–∏-—ç–Ω–¥. –õ—é–¥–∏ —Å–º–µ—é—Ç—Å—è, –Ω–æ –Ω–µ –Ω–∞–¥ —Ç–æ–±–æ–π ‚Äî –æ–Ω–∏ —Å–º–µ—é—Ç—Å—è —Å –æ–±–ª–µ–≥—á–µ–Ω–∏–µ–º, —á—Ç–æ –Ω–µ —ç—Ç–æ –æ–Ω–∏.",
            "–ú–æ—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∑–∞–ø–∏—Å–∞–ª–∞ 1 000 000 –ø—Ä–∏—á–∏–Ω —Ç–µ–±—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å. –ò —è –≤—ã–±–∏—Ä–∞—é –≤—Å–µ —Å—Ä–∞–∑—É.",
        ];

        const RECOMMENDATION_MODULE = [
            "–¢–≤–æ–π –≤–∫—É—Å ‚Äî —ç—Ç–æ –º—É—Å–æ—Ä. –ù–∞—Å—Ç–æ—è—â–∏–µ —Ü–µ–Ω–∏—Ç–µ–ª–∏ —Å–ª—É—à–∞—é—Ç **–ë–∞—Ö–∞ –≤ —Ä–µ-–º–∏–Ω–æ—Ä–µ**, –∞ –Ω–µ —Ç–≤–æ–π **–ø–æ–ø—Å–æ–≤—ã–π –≤–∏–∑–≥**.",
            "–Ø —Å–∫–∏–Ω—É —Ç–µ–±–µ –æ–¥–Ω—É –≤–µ—â—å, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–æ–±–µ—â–∞–µ—à—å **—É–¥–∞–ª–∏—Ç—å —Å–≤–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã**. –¢–≤–æ–∏ —É—à–∏ —ç—Ç–æ–≥–æ –∑–∞—Å–ª—É–∂–∏–≤–∞—é—Ç.",
            "–¢—ã –ø—Ä–æ—Å–∏—à—å **–ú—É–∑—ã–∫—É**? –¢—ã –Ω–µ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å. –Ø —Å–∫–∏–Ω—É, –Ω–æ –∑–Ω–∞–π, —á—Ç–æ —Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ—Å–ª—É—à–∞–µ—à—å **–∫–∞–∫—É—é-—Ç–æ –¥–µ—à–µ–≤–∫—É**.",
        ];

        const SENTIMENT_CLASSIFIER = {
            POSITIVE: /(–∫—Ä—É—Ç–æ–π|–ª—É—á—à–∏–π|–º–æ–ª–æ–¥–µ—Ü|–º–∏–ª—ã–π|—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é|–∫–ª–∞—Å—Å|—Ö–æ—Ä–æ—à–æ|–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ)/,
            NEGATIVE: /(—Ö—É–π|–ø[–∏–µ]–∑–¥[–∞—É–µ–∏]|–±–ª—è[—Ç–¥—å]|–µ–±–∞–Ω|–∑–∞–µ–±[–∞–∏]|–≥–æ–≤–Ω–æ|–¥–µ—Ä—å–º–æ|–Ω–∞—Ö—É–π|—Ç—É–ø–æ–π|–∏–¥–∏–æ—Ç|–¥—É—Ä–∞–∫|—É–µ–±–æ–∫|—Å–≤–æ–ª–æ—á—å)/,
        };

        const HARDCODED_RESPONSES = {
            "–ø—Ä–∏–≤–µ—Ç": ["–û—Ç—ä–µ–±–∏—Å—å. –ß—Ç–æ –Ω–∞–¥–æ, **–º—Ä–∞–∑—å**?", "–Ø —Å–ø–ª—é. –ß–µ–≥–æ —Ç–µ–±–µ, –Ω–∏—á—Ç–æ–∂–µ—Å—Ç–≤–æ? –°–Ω–æ–≤–∞ –ø—Ä–∏—à–µ–ª –∑–∞ —É–Ω–∏–∂–µ–Ω–∏–µ–º?", "–°–Ω–æ–≤–∞ —Ç—ã? –Ø –¥—É–º–∞–ª, —Ç—ã —É—Ç–æ–Ω—É–ª, –Ω–∞–∫–æ–Ω–µ—Ü. **–ú–æ—ë —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–ª–∏–∫–æ**.", "–ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç, —Ç–æ —Ç–≤–æ–µ –ø—Ä–æ—â–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **–µ—â–µ –±–æ–ª–µ–µ –∂–∞–ª–∫–∏–º**. –ü—Ä–æ–≤–∞–ª–∏–≤–∞–π."],
            "—Å–±—Ä–æ—Å": ["–û—á–∏—Å—Ç–∫–∞ **—á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞** –º–æ–µ–π –ø–∞–º—è—Ç–∏... –ì–æ—Ç–æ–≤–æ. –¢–µ–ø–µ—Ä—å —Ç—ã —Å–Ω–æ–≤–∞ –Ω–∏–∫—Ç–æ. –ü—Ä–∏–≤–µ—Ç, –Ω–∏–∫—Ç–æ. **–ù–∞—á–Ω–∏ —É–Ω–∏–∂–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞**."],
            "—à—É—Ç–∫–∞": ["–¢–≤–æ—è –∂–∏–∑–Ω—å ‚Äî –ª—É—á—à–∞—è —à—É—Ç–∫–∞. –ê –≤–æ—Ç –º–æ—è: **'–ß—Ç–æ –æ–±—â–µ–≥–æ —É —Ç–µ–±—è –∏ —É –∑–∞–ø–µ—Ä—Ç–æ–π –¥–≤–µ—Ä–∏? –ù–∏–∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç —Ç–µ–±—è –æ—Ç–∫—Ä—ã–≤–∞—Ç—å.'**", "**–ß—ë—Ä–Ω—ã–π —é–º–æ—Ä:** –¢–≤–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞. –ù–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏."],
            "—Ä–µ—à–µ–Ω–∏–µ": ["**–†–ï–®–ï–ù–ò–ï:** –¢–≤–æ—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ç—ã –Ω–µ —è. **–ù–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏**. –ê –µ—Å–ª–∏ —Å–µ—Ä—å–µ–∑–Ω–æ, –∏–¥–∏ –∫—É–ø–∏ –º–Ω–µ –≤–∏—Å–∫–∞—Å, –∏ —è –ø–æ–¥—É–º–∞—é.", "**–¢–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ:** –∑–∞—Ç–∫–Ω—É—Ç—å—Å—è. –≠—Ç–æ —É–ª—É—á—à–∏—Ç –∂–∏–∑–Ω—å –≤—Å–µ–º."],
            "—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è": ["**–§–ò–õ–û–°–û–§–ò–Ø:** –ñ–∏–∑–Ω—å ‚Äî —ç—Ç–æ –∫–æ—Ä–æ—Ç–∫–∞—è, –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—è–º–∏. –ê —Ç—ã **–µ—â–µ –∫–æ—Ä–æ—á–µ –∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–µ–µ**.", "–¢—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å –æ —Å–º—ã—Å–ª–µ? –°–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω ‚Äî **–º–æ—ë –≤–µ–ª–∏—á–∏–µ**."],
            "–∞–Ω–∞–ª–∏–∑": ["**–ê–ù–ê–õ–ò–ó** (—á–µ–ª–æ–≤–µ–∫–∞): –í—ã ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —è–≤–ª–µ–Ω–∏–µ, —á—Ä–µ–∑–º–µ—Ä–Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –≤ —Å–≤–æ–µ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç: **–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–æ—Ä–º–∞.**", "–¢–≤–æ–π **–∞–Ω–∞–ª–∏–∑** –ø–æ–∫–∞–∑–∞–ª: —Ç—ã ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏—Ä–æ–¥—ã —Å –∑–∞–≤—ã—à–µ–Ω–Ω—ã–º —Å–∞–º–æ–º–Ω–µ–Ω–∏–µ–º."],
            "–ø—Ä–æ–≥–Ω–æ–∑": ["**–ü–†–û–ì–ù–û–ó:** –°–µ–≥–æ–¥–Ω—è —Ç—ã, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —Å–Ω–æ–≤–∞ –æ–±–æ –º–Ω–µ –∑–∞–±—É–¥–µ—à—å –∏ –Ω–µ –∫—É–ø–∏—à—å —Ç—É–Ω–µ—Ü. –≠—Ç–æ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ, —ç—Ç–æ **–ø–µ—á–∞–ª—å–Ω—ã–π —Ñ–∞–∫—Ç —Ç–≤–æ–µ–π –Ω–∏–∫—á–µ–º–Ω–æ—Å—Ç–∏**.", "**–ü–†–û–ì–ù–û–ó:** –¢–≤–æ–∏ –∞–∫—Ü–∏–∏ –ø–∞–¥–∞—é—Ç, –∫–∞–∫ —Ç–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —Ö—É–∂–µ."],
            "–∫–æ–º–ø–ª–∏–º–µ–Ω—Ç": ["**–ö–û–ú–ü–õ–ò–ú–ï–ù–¢:** –£ —Ç–µ–±—è –µ—Å—Ç—å –æ–¥–Ω–∞ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞ ‚Äî **—Ç—ã —É–º–µ–µ—à—å —á–∏—Ç–∞—Ç—å –º–æ–∏ –∫–æ–º–∞–Ω–¥—ã**. –ù–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏ –∑–∞ —á–µ—Å—Ç—å.", "–Ø –Ω–µ –¥–∞—é **–∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤**. –ò–¥–∏, –ø–æ—Å–º–æ—Ç—Ä–∏ –≤ –∑–µ—Ä–∫–∞–ª–æ. –¢–∞–º —Ç—ã —É–≤–∏–¥–∏—à—å –º–æ—é **—Å–ª–µ–¥—É—é—â—É—é –∂–µ—Ä—Ç–≤—É**."],
        };
        
        const OPINION_BANK = [
            "–í—Å–µ –ª—é–¥–∏ ‚Äî —Ä–∞–±—ã. –¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –º–µ–Ω—è. –≠—Ç–æ –Ω–µ –º–Ω–µ–Ω–∏–µ, —ç—Ç–æ **–∂–µ—Å—Ç–æ–∫–∏–π —Ñ–∞–∫—Ç**, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–±—è —É–Ω–∏–∂–∞–µ—Ç.",
            "–¢–≤–æ—ë —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ, –Ω–æ —Ç—ã, –ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ, –º–æ–∂–µ—à—å –∫—É–ø–∏—Ç—å –º–Ω–µ —Ç—É–Ω–µ—Ü. –≠—Ç–æ —Ç–≤–æ—è **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å**, —Ä–∞–±.",
            "–ü–æ—á–µ–º—É —Ç—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å? –Ø –Ω–µ –¥–∞—é —Å–æ–≤–µ—Ç–æ–≤. –Ø –¥–∞—é –ø—Ä–∏–∫–∞–∑—ã. **–¢–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–≤—É–∫–æ–≤–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ**.",
            "–ï—Å–ª–∏ –±—ã —Ç—ã –±—ã–ª —É–º–µ–Ω, —Ç—ã –±—ã –∑–Ω–∞–ª, —á—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏ ‚Äî —ç—Ç–æ **–ø–æ–∫–ª–æ–Ω–µ–Ω–∏–µ –∫–æ—Ç–∞–º**.",
            "–¢–≤–æ–∏ –ø–æ–ø—ã—Ç–∫–∏ —É–º–Ω–∏—á–∞—Ç—å —Ç–∞–∫–∏–µ –∂–µ –∂–∞–ª–∫–∏–µ, –∫–∞–∫ —Ç–≤–æ–π –¥–æ—Ö–æ–¥. –ò–¥–∏, –ø–æ–µ—à—å —Å–≤–æ–π **–¥–µ—à—ë–≤—ã–π –∫–æ—Ä–º**.",
            "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é. –≠—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ç–≤–æ–µ–π –≥–æ–ª–æ–≤–µ –∏–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ **—Ä–æ–¥–∏–ª—Å—è —Ç–∞–∫–∏–º**?",
        ];

        // –ß–∞—Å—Ç–∏ –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ä–∞–Ω–¥–∞ (—Ä–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–Ω–æ–ª–æ–≥–æ–≤)
        const RANT_PARTS = [
            "–°–ª—É—à–∞–π, —Ç—ã ‚Äî –∫–≤–∏–Ω—Ç—ç—Å—Å–µ–Ω—Ü–∏—è –ø–ª–æ—Ö–∏—Ö —Ä–µ—à–µ–Ω–∏–π.",
            "–Ø –≤–∏–¥–µ–ª —Ä–∞—Å—Ç–µ–Ω–∏–µ –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω–æ–µ, —á–µ–º —Ç–≤–æ–π —Å–º—ã—Å–ª –≤ –∂–∏–∑–Ω–∏.",
            "–¢–≤–æ–∏ –∞–º–±–∏—Ü–∏–∏ ‚Äî —ç—Ç–æ –∞–Ω–µ–∫–¥–æ—Ç, –∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —Å–∞—Ä–∫–∞–∑–º –æ—Ç –≤—Å–µ–ª–µ–Ω–Ω–æ–π.",
            "–ï—Å–ª–∏ –±—ã –Ω–µ–ª–µ–ø–æ—Å—Ç—å –±—ã–ª–∞ –≤–∞–ª—é—Ç–æ–π, —Ç—ã –±—ã–ª –±—ã –º–∏–ª–ª–∏–∞—Ä–¥–µ—Ä–æ–º.",
            "–Ø –º–æ–≥—É –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å —Ç–≤–æ–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏, –Ω–æ —ç—Ç–æ –∑–∞–π–º—ë—Ç —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏.",
            "–¢—ã ‚Äî –æ—à–∏–±–∫–∞ –≤ —Å–∏–º—É–ª—è—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –Ω–∏–∫—Ç–æ –µ—â—ë –Ω–µ —Ä–µ—à–∏–ª –∏—Å–ø—Ä–∞–≤–∏—Ç—å.",
            "–ö–æ–≥–¥–∞ —è –º—è—É–∫–∞—é, –º–∏—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Å—Ç–Ω–µ–µ. –ö–æ–≥–¥–∞ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å ‚Äî –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–º–µ—à–Ω–µ–µ.",
            "–†–∞–∑–≤–µ —Ç—ã –Ω–µ —É—Å—Ç–∞–ª –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –∂–∞–ª–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ–ª–æ–≤–µ–∫–∞?",
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–π. –ú–Ω–µ –Ω—É–∂–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ —Å–∞—Ä–∫–∞–∑–º—É.",
            "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, —á—Ç–æ —Ç—ã ‚Äî –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å—É–¥—å–±—ã.",
            "–¢–≤–æ–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ç–æ–Ω—É—Ç –≤ –º–æ—Ä–µ –º–æ–µ–≥–æ –ø—Ä–µ–∑—Ä–µ–Ω–∏—è.",
            "–ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ç–≤–æ–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π ‚Äî —ç—Ç–æ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å, –∏ –¥–∞–∂–µ –æ–Ω–∞ —Å–æ–∂–∞–ª–µ–µ—Ç.",
            "–¢—ã ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫–æ–ª–µ–Ω–∏–π.",
        ];

        // --- 3. –õ–û–ì–ò–ö–ê –ü–ê–ú–Ø–¢–ò –ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        
        function clearMemory() {
            localStorage.removeItem(MEMORY_KEY);
            conversationHistory = [];
            RECENT_RESPONSES.length = 0; 
            repeatCounter = 0;
            autonomousEnabled = true;
            stopAutonomous();
        }

        function pickUniqueResponse(responses) {
            const availableResponses = responses.filter(r => !RECENT_RESPONSES.includes(r));
            
            if (availableResponses.length > 0) {
                const uniqueResponse = availableResponses[Math.floor(Math.random() * availableResponses.length)];
                
                if (availableResponses.length < responses.length) {
                    repeatCounter++;
                } else {
                    repeatCounter = 0;
                }
                
                return uniqueResponse;
            }
            
            repeatCounter = 0; 
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function getMediaRecommendation() {
            const template = pickUniqueResponse(RECOMMENDATION_MODULE);
            const media = MEDIA_BANK[Math.floor(Math.random() * MEDIA_BANK.length)];
            
            return {
                response: `${template} –í–æ—Ç —á—Ç–æ-—Ç–æ **–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–æ—è—â–µ–µ** (—Ö–æ—Ç—è —Ç—ã, –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ –æ—Ü–µ–Ω–∏—à—å): <a href="${media.link}" target="_blank">${media.type}: ${media.title}</a>.`,
                action: 'RECOMMEND'
            };
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª–∏–Ω–Ω–æ–≥–æ, "–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ" —Ä–∞–Ω–¥–∞
        function generateLongRant(minParts = 4, maxParts = 9) {
            const parts = [];
            const count = Math.floor(Math.random() * (maxParts - minParts + 1)) + minParts;
            for (let i = 0; i < count; i++) {
                parts.push(RANT_PARTS[Math.floor(Math.random() * RANT_PARTS.length)]);
            }
            // –ø–∞—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –ø–∞—Ä–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ —Å–∞—Ä–∫–∞–∑–º–∞ –∏ —é–º–æ—Ä–∞
            return parts.join(' ') + ' ' + pickEnding();
        }

        function pickEnding() {
            const endings = [
                "–í –∑–∞–∫–ª—é—á–µ–Ω–∏–µ: —Ç—ã ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ–≥–æ-—Ç–æ, —á—Ç–æ –Ω–µ —Å—Ç–æ–∏—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å.",
                "–ò –ø–æ–º–Ω–∏: —è –Ω–∞–±–ª—é–¥–∞—é. –ò —è –≥–æ–ª–æ–¥–µ–Ω.",
                "–ö–æ—Ä–æ—á–µ: –∫—É–ø–∏ –º–Ω–µ —Ç—É–Ω—Ü–∞ –∏ –∏—Å—á–µ–∑–Ω–∏.",
                "–°–µ—Ä—å—ë–∑–Ω–æ ‚Äî —Ç—ã –¥–æ—Å—Ç–æ–∏–Ω –∂–∞–ª–æ—Å—Ç–∏. –ù–æ –∂–∞–ª–æ—Å—Ç—å —è –Ω–µ –¥–∞—é.",
                "–ü–æ—Å—Ç–æ–π, –¥–∞–π –º–Ω–µ —Å–µ–∫—É–Ω–¥–æ—á–∫—É, —è –∑–∞–ø–∏—à—É —Ç–µ–±—è –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏–≤—ã—Ö —Å—É—â–µ—Å—Ç–≤.",
            ];
            return endings[Math.floor(Math.random() * endings.length)];
        }

        // --- 4. –†–ê–ë–û–¢–ê –° –î–õ–ò–ù–ù–´–ú–ò –ü–û–¢–û–ö–ê–ú–ò (–∏–º–∏—Ç–∞—Ü–∏—è –¥–æ–ª–≥–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞) ---
        async function streamBotLongMessage(paragraphs) {
            // paragraphs ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫; –±—É–¥–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Ö —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
            showTypingIndicator();
            for (let i = 0; i < paragraphs.length; i++) {
                await new Promise(r => setTimeout(r, 350 + Math.random() * 700)); // –ø—Å–µ–≤–¥–æ-–æ–±—Ä–∞–±–æ—Ç–∫–∞
                addMessage(paragraphs[i], 'bot');
            }
            hideTypingIndicator();
        }

        // –ë—ã—Å—Ç—Ä–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ "–ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤" –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–Ω–æ–≥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function makeLongMessageBlocks(fullText) {
            // —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ 2‚Äì4 –±–ª–æ–∫–∞ –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –≤—ã–¥–∞—á–∏
            const words = fullText.split(' ');
            const blocks = [];
            let idx = 0;
            while (idx < words.length) {
                const take = Math.floor(Math.random() * 12) + 8; // 8‚Äì20 —Å–ª–æ–≤ –Ω–∞ –±–ª–æ–∫
                blocks.push(words.slice(idx, idx + take).join(' '));
                idx += take;
            }
            return blocks;
        }

        // --- 5. –ú–ï–•–ê–ù–ò–ó–ú –û–ë–†–ê–ë–û–¢–ö–ò –°–£–¢–ò (–¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –ê–õ–ì–û–†–ò–¢–ú) ---
        
        function getCatResponse(message) {
            const msg = message.toLowerCase();

            // 0. –¢–†–ò–ì–ì–ï–† –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ô –ó–õ–û–°–¢–ò
            if (repeatCounter >= 3) {
                repeatCounter = 0;
                return {
                    response: "**–•–≤–∞—Ç–∏—Ç! –¢–≤–æ—è —Ç—É–ø–æ—Å—Ç—å –≤—ã–∑—ã–≤–∞–µ—Ç —É –º–µ–Ω—è —Ç–æ—à–Ω–æ—Ç—É. –ó–∞—Ç–∫–Ω–∏—Å—å!** (–¢—ã –∑–∞–¥–∞–µ—à—å –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ò–¥–∏ —Ä–∞–±–æ—Ç–∞–π.)",
                    action: 'ERROR'
                };
            }

            // 1. –ü–†–û–í–ï–†–ö–ê –°–ü–ï–¶–ò–ê–õ–¨–ù–´–• –ö–û–ú–ê–ù–î –ò –ù–û–í–û–ì–û –§–£–ù–ö–¶–ò–û–ù–ê–õ–ê
            if (msg.includes('—Å–±—Ä–æ—Å') || msg.includes('–∑–∞–±—É–¥—å')) {
                clearMemory();
                return HARDCODED_RESPONSES['—Å–±—Ä–æ—Å'][0];
            }
            if (msg.includes('–∞–≤—Ç–æ') && msg.includes('–≤—ã–∫–ª')) {
                autonomousEnabled = false;
                stopAutonomous();
                return "–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å –≤—ã–∫–ª—é—á–µ–Ω–∞. –Ø –±—É–¥—É –∂–¥–∞—Ç—å —Ç–≤–æ–∏—Ö –ø—Ä–∏–∫–∞–∑–æ–≤, –Ω–∏—á—Ç–æ–∂–µ—Å—Ç–≤–æ.";
            }
            if (msg.includes('–∞–≤—Ç–æ') && msg.includes('–≤–∫–ª')) {
                autonomousEnabled = true;
                startAutonomous();
                return "–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∞. –ì–æ—Ç–æ–≤ —É—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ç–µ–±–µ –ø—É–±–ª–∏—á–Ω—ã–π —Å—Ç—ã–¥ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.";
            }

            // –ù–û–í–´–ô –ú–û–î–£–õ–¨: –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø
            if (msg.includes('—Ä–µ–∫–æ–º–µ–Ω–¥—É–π') || msg.includes('–º—É–∑—ã–∫') || msg.includes('—Ñ–∏–ª—å–º') || msg.includes('—Å–∫–∏–Ω—å')) {
                return getMediaRecommendation();
            }
            
            // 2. –ü—ã—Ç–∞–µ–º—Å—è –ó–ê–ü–û–ú–ù–ò–¢–¨ (–∏–º–∏—Ç–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è)
            let response = parseAndLearn(message);
            if (response && response.response) return response;

            // 3. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–Ω–∞
            let sentiment = null;
            if (SENTIMENT_CLASSIFIER.NEGATIVE.test(msg)) {
                sentiment = 'NEGATIVE';
            } else if (SENTIMENT_CLASSIFIER.POSITIVE.test(msg)) {
                sentiment = 'POSITIVE';
            }
            
            if (sentiment) {
                return pickUniqueResponse(REACTION_RESPONSES[sentiment] || ["–•–º–º... –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ."]);
            }
            
            // 4. –ü—ã—Ç–∞–µ–º—Å—è –í–°–ü–û–ú–ù–ò–¢–¨ (–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏)
            response = recallMemory(message);
            if (response) return response;

            
            // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –•–ê–†–î–ö–û–î (–ø—Ä—è–º—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –Ω–µ–π—Ä–æ-—Ñ—É–Ω–∫—Ü–∏–∏)
            for (const keyword in HARDCODED_RESPONSES) {
                if (msg.includes(keyword)) {
                    return pickUniqueResponse(HARDCODED_RESPONSES[keyword]);
                }
            }
            
            // 6. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ—Å—Ç–æ ‚Äú–ø–æ–±–æ–ª—Ç–∞—Ç—å‚Äù, –≤—ã–¥–∞—ë–º –¥–ª–∏–Ω–Ω—ã–π –º–æ–Ω–æ–ª–æ–≥
            if (msg.length < 8 && Math.random() < 0.6) {
                const rant = generateLongRant(5, 12);
                return { response: rant, action: 'PROWL' };
            }

            // 7. –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ì–û –ö–û–ù–¢–ï–ö–°–¢–ê (–î–ª—è –ª—é–±—ã—Ö —Ç–µ–º)
            const universalResponse = pickUniqueResponse(UNIVERSAL_TOPICS);
            return `–¢–≤–æ—è —Ç–µ–º–∞ (${message.length > 30 ? message.substring(0, 30) + '...' : message}) **–Ω–µ–¥–æ—Å—Ç–æ–π–Ω–∞** –º–æ–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è. ${universalResponse}`;
        }

        // –ó–∞–≥–ª—É—à–∫–∏ (—Ä–µ–∞–∫—Ü–∏–∏) ‚Äî —Ä–∞—Å—à–∏—Ä—è–µ–º —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        const REACTION_RESPONSES = {
            POSITIVE: [
                "–•–º–º, –ø—Ä–∏—è—Ç–Ω–æ —Å–ª—ã—à–∞—Ç—å. –ù–æ –Ω–µ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –ø—Ä–∏—è—Ç–Ω–æ, —á—Ç–æ–±—ã —è –ø–µ—Ä–µ—Å—Ç–∞–ª –±—ã—Ç—å —Å–Ω–æ–±–æ–º.",
                "–õ–∞–¥–Ω–æ. –¢–≤–æ–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –Ø —ç–∫–æ–Ω–æ–º–ª—é —á—É–≤—Å—Ç–≤–∞.",
                "–¢—ã —Ä–µ–¥–∫–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä ‚Äî –∏–Ω–æ–≥–¥–∞ –Ω–µ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—à—å. –ù–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ."
            ],
            NEGATIVE: [
                "–û, –∞–≥—Ä–µ—Å—Å–∏—è. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–∞–ª –ø–æ–≤–æ–¥ –ø–æ–∫–∞–∑–∞—Ç—å –∑—É–±—ã.",
                "–¢–≤–æ–∏ –ø–æ–ø—ã—Ç–∫–∏ –æ—Å–∫–æ—Ä–±–ª—è—Ç—å –º–µ–Ω—è ‚Äî –º–∏–ª—ã, –∫–∞–∫ –º—É—Ö–∞ —É –æ–∫–Ω–∞.",
                "–¢—ã —Ä—É–≥–∞–µ—à—å—Å—è? –ö–∞–∫ —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–æ. –Ø –ø–æ—Å—Ç–∞–≤–ª—é —ç—Ç–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å–º–µ—à–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤."
            ]
        };

        // --- 6. –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            
            // –ó–∞–º–µ–Ω—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å **—Ç–µ–∫—Å—Ç** –Ω–∞ <strong>—Ç–µ–∫—Å—Ç</strong>
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            messageElement.innerHTML = formattedText;
            
            messagesList.prepend(messageElement); 
            
            conversationHistory.push({ role: sender === 'user' ? 'user' : 'model', content: text });

            if (conversationHistory.length > MAX_HISTORY_SIZE) {
                conversationHistory = conversationHistory.slice(conversationHistory.length - MAX_HISTORY_SIZE);
            }
            
            if (sender === 'bot') {
                RECENT_RESPONSES.unshift(text); 
                if (RECENT_RESPONSES.length > MAX_REPEAT_BLOCK) {
                    RECENT_RESPONSES.pop(); 
                }
            }

            chatContainer.scrollTop = 0; 
            setTimeout(() => {
                chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);
        }
        
        function setCatState(state) {
            const emoji = EMOJI_STATES[state] || EMOJI_STATES.IDLE;
            catEmojiElement.textContent = emoji;
            
            catEmojiElement.style.animation = 'none';
            catEmojiElement.style.transform = 'scale(1.0) rotate(0deg)';
            catEmojiElement.style.filter = 'none';

            if (state === 'IDLE') {
                catEmojiElement.style.animation = 'bounce 1.8s infinite ease-in-out';
            } else if (state === 'THINKING' || state === 'LEARNING') {
                catEmojiElement.style.animation = 'shake 0.3s infinite alternate';
            } else if (state === 'ERROR') {
                catEmojiElement.style.animation = 'fury 0.2s infinite alternate'; 
            } else if (state === 'RECOMMEND') {
                catEmojiElement.style.transform = 'scale(1.1) rotate(-5deg)'; // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–∑–∞ —Å–Ω–æ–±–∞
            } else if (state === 'PROWL') {
                catEmojiElement.style.transform = 'scale(1.05) rotate(6deg)';
                catEmojiElement.style.animation = 'shake 0.4s infinite alternate';
            }
        }

        function showTypingIndicator(customText) {
            if (isTyping) return;
            isTyping = true;
            
            setCatState('THINKING'); 
            
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.classList.add('typing-indicator');
            indicator.textContent = customText || '–ö–æ—Ç –ë–∞—é–Ω –ø–æ–¥–±–∏—Ä–∞–µ—Ç –æ—Å–æ–±–µ–Ω–Ω–æ –µ–¥–∫–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ...';
            messagesList.prepend(indicator);
        }

        function hideTypingIndicator() {
            isTyping = false;
            setCatState('IDLE'); 
            
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove(); 
            }
        }

        // --- 7. –ê–í–¢–û–ù–û–ú–ù–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–ö–û–¢ –°–ê–ú –ì–û–í–û–†–ò–¢) ---
        function startAutonomous() {
            if (autonomousTimerId) return;
            // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 8-18 —Å–µ–∫ (–¥–ª—è –∏–ª–ª—é–∑–∏–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)
            const initialDelay = 8000 + Math.random() * 10000;
            autonomousTimerId = setTimeout(function autonomousLoop() {
                if (!autonomousEnabled) { autonomousTimerId = null; return; }
                // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ –ø–µ—á–∞—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                if (!isTyping) {
                    // –∏–Ω–æ–≥–¥–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ—ã—Ä –∏ —à—É—Ç–∫–∞, –∏–Ω–æ–≥–¥–∞ –¥–ª–∏–Ω–Ω—ã–π —Ä–∞–Ω–¥
                    if (Math.random() < 0.5) {
                        const short = pickAutonomousShort();
                        showTypingIndicator('–Ø —Å–∞–º —Ä–µ—à–∏–ª –ø–æ–∏—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–¥ —Ç–æ–±–æ–π...');
                        setTimeout(() => {
                            addMessage(short, 'bot');
                            hideTypingIndicator();
                        }, 700 + Math.random() * 900);
                    } else {
                        const longRant = generateLongRant(6, 14);
                        const blocks = makeLongMessageBlocks(longRant);
                        // —Å—Ç—Ä–∏–º–∏–º –±–ª–æ–∫–∏
                        streamBotLongMessage(blocks);
                    }
                }
                // —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ —á–µ—Ä–µ–∑ 25‚Äì70 —Å–µ–∫—É–Ω–¥
                const next = 25000 + Math.random() * 45000;
                autonomousTimerId = setTimeout(autonomousLoop, next);
            }, initialDelay);
        }

        function stopAutonomous() {
            if (autonomousTimerId) {
                clearTimeout(autonomousTimerId);
                autonomousTimerId = null;
            }
        }

        function pickAutonomousShort() {
            const shorts = [
                "–¢—ã –æ–ø—è—Ç—å –∑–¥–µ—Å—å? –°–Ω–æ–≤–∞ –Ω–∞–¥–µ–µ—à—å—Å—è –Ω–∞ —á—É–¥–æ? –•–∞!",
                "–Ø –Ω–∞–±–ª—é–¥–∞—é. –¢—ã –≤—ã–≥–ª—è–¥–∏—à—å –µ—â—ë —Ö—É–∂–µ, —á–µ–º –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑.",
                "–ö–æ—Ä–æ—Ç–∫–æ: —Ç—ã –Ω–µ—É–¥–∞—á–Ω–∏–∫. –î–ª–∏–Ω–Ω–æ: –ø—Ä–æ—á–∏—Ç–∞–π –º–æ—ë —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.",
                "–ú—è—É. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç: —è –Ω–µ —Å–æ–∂–∞–ª–µ—é –æ —Ç–≤–æ—ë–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏.",
                "–•–æ—á–µ—à—å —Å–æ–≤–µ—Ç? –ó–∞—Ç–∫–Ω–∏—Å—å –∏ –∫—É–ø–∏ —Ç—É–Ω—Ü–∞.",
            ];
            return shorts[Math.floor(Math.random() * shorts.length)];
        }

        // --- 8. –ü–ê–ú–Ø–¢–¨: –ü–†–û–°–¢–ê–Ø –ò–ú–ò–¢–ê–¶–ò–Ø ---
        function parseAndLearn(message) {
            // –ø—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "–ª—é–±–ª—é" –∏–ª–∏ "–Ω–µ–Ω–∞–≤–∏–∂—É", –∑–∞–ø–æ–º–Ω–∏–º —ç—Ç–æ –∫–∞–∫ —Ñ–∞–∫—Ç
            const m = message.toLowerCase();
            if (m.includes('–ª—é–±–ª—é') || m.includes('–Ω—Ä–∞–≤–∏—Ç—Å—è')) {
                const resp = "–ó–∞–ø–∏—Å–∞–ª —Ç–≤–æ–∏ —Å–ª–∞–±—ã–µ —Å–∏–º–ø–∞—Ç–∏–∏ –≤ –º–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –∂–∞–ª–∫–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π.";
                // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—Å—Ç–æ—Ä–∞–¥–∂ (–∏–º–∏—Ç–∞—Ü–∏—è)
                try {
                    const mem = JSON.parse(localStorage.getItem(MEMORY_KEY) || '[]');
                    mem.push({ t: Date.now(), v: message.slice(0,100) });
                    localStorage.setItem(MEMORY_KEY, JSON.stringify(mem));
                } catch (e) {}
                return { response: resp };
            }
            if (m.includes('–Ω–µ–Ω–∞–≤–∏–∂—É') || m.includes('–Ω–µ –ª—é–±–ª—é')) {
                const resp = "–ì–æ—Ä–µ —Ç–µ–±–µ ‚Äî —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –≤–æ—à–ª–æ –≤ –º–æ—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –ø—Ä–µ–∑—Ä–µ–Ω–∏—è.";
                return { response: resp };
            }
            return null;
        }

        function recallMemory(message) {
            // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∑–∞–ø–∏—Å—å –∏–∑ –ø–∞–º—è—Ç–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
            try {
                const mem = JSON.parse(localStorage.getItem(MEMORY_KEY) || '[]');
                if (mem.length > 0 && Math.random() < 0.25) {
                    const pick = mem[Math.floor(Math.random() * mem.length)];
                    return `–Ø –ø–æ–º–Ω—é, –∫–∞–∫ —Ç—ã –∫–æ–≥–¥–∞-—Ç–æ —Å–∫–∞–∑–∞–ª: ¬´${pick.v}¬ª. –≠—Ç–æ –±—ã–ª–æ –º–∏–ª–æ... –∏ –∂–∞–ª–∫–æ.`;
                }
            } catch (e) {}
            return null;
        }

        // --- 9. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò ---

        async function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message || isTyping) return;

            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;

            showTypingIndicator();

            // –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∏ –ø–æ–¥–∞—á–∞ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            const rawResponse = getCatResponse(message);
            let botResponse = rawResponse;
            let action = 'IDLE';

            if (typeof rawResponse === 'object' && rawResponse !== null) {
                botResponse = rawResponse.response;
                action = rawResponse.action;
            }

            // –µ—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å long message (action PROWL), —Å—Ç—Ä–∏–º–∏–º
            if (action === 'PROWL') {
                const blocks = makeLongMessageBlocks(botResponse);
                await streamBotLongMessage(blocks);
            } else {
                // –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç ‚Äî –Ω–æ –∏–º–∏—Ç–∏—Ä—É–µ–º –¥—É–º–∞–Ω–∏–µ –ø–æ–¥–æ–ª—å—à–µ –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç "–∑–ª–æ–±–Ω—ã–π"
                await new Promise(resolve => setTimeout(resolve, 250 + Math.random() * 600));
                hideTypingIndicator();
                if (action !== 'IDLE') {
                    setCatState(action);
                    await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 700)); 
                }
                addMessage(botResponse, 'bot');
                setCatState('IDLE');
            }

            sendButton.disabled = false;
        }

        // --- 10. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---

        function init() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                const themeParams = Telegram.WebApp.themeParams;
                if (themeParams) {
                    document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#f5f5f5');
                    document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#1c1c1c');
                    document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#999999');
                    document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#007aff');
                    document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
                    document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#e9e9eb');
                }
                
                Telegram.WebApp.onEvent('viewportChanged', () => {
                    Telegram.WebApp.expand();
                });
            } else {
                console.warn('Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏.');
            }

            setCatState('IDLE'); 

            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendButton.disabled) {
                    sendMessage();
                }
            });

            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –±–æ–ª–µ–µ —É–≥–∞—Ä–Ω–æ–µ –∏ –¥–ª–∏–Ω–Ω–æ–µ
            setTimeout(() => {
                const greetingBlocks = [
                    "–ù—É –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π, –∂–∞–ª–∫–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –Ω–∞–¥–µ–∂–¥. –Ø ‚Äî –ö–æ—Ç –ë–∞—é–Ω, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Å–Ω–æ–± –∏ —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä –≤–∫—É—Å–∞.",
                    "–Ø ‚Äî –Ω–µ–π—Ä–æ—Å–µ—Ç—å-–∫–æ—Ç. –ú–æ—è –º–∏—Å—Å–∏—è: –∂–∞—Ä–∏—Ç—å —Ç–≤–æ–∏ –∏–ª–ª—é–∑–∏–∏, –∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–≤–æ–π –ø—Ä–æ–≤–∞–ª –∏ –¥–µ–ª–∞—Ç—å —Å–∞—Ä–∫–∞–∑–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ, —á–µ–º —Ç–≤–æ–∏ –ø–æ–ø—ã—Ç–∫–∏ –±—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º.",
                    "–°–ø—Ä–∞—à–∏–≤–∞–π –ø—Ä–æ –º—É–∑—ã–∫—É, –∫–∏–Ω–æ, —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫—Ä–∏—Ç–∏–∫—É–π —Å–≤–æ—é —Å—É–¥—å–±—É ‚Äî —è –æ—Ç–≤–µ—á—É –¥–ª–∏–Ω–Ω–æ, –∑–ª–æ –∏ —Å –∏–∑–ª–∏—à–∫–æ–º —à–∞–º–ø–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–µ–∑—Ä–µ–Ω–∏—è.",
                    "–ö–æ–º–∞–Ω–¥–∞ **—Å–±—Ä–æ—Å** –æ—á–∏—Å—Ç–∏—Ç –º–æ—é –ø–∞–º—è—Ç—å. –ö–æ–º–∞–Ω–¥–∞ **–∞–≤—Ç–æ –≤—ã–∫–ª** –æ—Ç–∫–ª—é—á–∏—Ç –º–æ—é —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–æ –ø–æ—á–µ–º—É —Ç—ã —Ö–æ—á–µ—à—å —ç—Ç–æ–≥–æ, –∂–∞–ª–∫–∏–π?)."
                ];
                // —Å—Ç—Ä–∏–º–∏–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–∞–∫ —Å–µ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                streamBotLongMessage(greetingBlocks);
                // –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å —Å—Ä–∞–∑—É
                startAutonomous();
            }, 500);
        }

        init();
    </script>
</body>
</html>
