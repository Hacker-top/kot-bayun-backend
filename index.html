<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>–ö–æ—Ç –ë–∞—é–Ω ‚Äî –ø–∏—Ç–æ–º–µ—Ü, –¥—Ä—É–≥ –∏ —Å–ª–æ–≤–µ—Å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
/* ---------- –ë–ê–ó–ê: –®–†–ò–§–¢, –ü–ê–õ–ò–¢–†–ê ---------- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

:root{
  --bg:#f5f7fb;
  --panel:#ffffff;
  --accent:#2f80ed;
  --muted:#8b95a6;
  --bubble-me:#2f80ed;
  --bubble-me-text:#ffffff;
  --bubble-bot:#f1f3f8;
  --bubble-bot-text:#111827;
  --danger:#ff3b30;
  --glass: rgba(15,23,42,0.03);
  --radius:16px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--bubble-bot-text)}
.app{
  max-width:920px;
  height:100vh;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  box-shadow:0 14px 40px rgba(16,24,40,0.06);
  background: linear-gradient(180deg,#fbfdff, #f4f7fb);
}

/* header */
.header{
  display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid rgba(15,23,42,0.04);background:var(--panel);
  flex-shrink:0;
}
#avatar{
  width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,#fff,#f0f4ff);display:flex;align-items:center;justify-content:center;font-size:38px;box-shadow:0 10px 24px rgba(47,128,237,0.06);
  transition:transform .12s ease;
}
.header-info{display:flex;flex-direction:column}
.header-title{font-weight:700;font-size:18px;margin:0}
.header-sub{font-size:13px;color:var(--muted);margin:0}

/* top actions */
.header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.icon-btn{background:var(--glass);border-radius:10px;padding:8px;cursor:pointer;border:0}
.small-tag{background:rgba(15,23,42,0.03);padding:6px 10px;border-radius:10px;font-size:13px;color:var(--muted)}

/* main chat area */
.container{display:flex;flex:1 1 auto;gap:0;overflow:hidden}
.left{flex:1;display:flex;flex-direction:column;border-right:1px solid rgba(15,23,42,0.03);background:linear-gradient(180deg,#fbfdff, #f7f9fc)}
.right{width:360px;background:var(--panel);display:flex;flex-direction:column;gap:12px;padding:14px;box-shadow:inset 0 1px 0 rgba(0,0,0,0.02)}
/* message list */
.messages-wrap{flex:1;display:flex;flex-direction:column;padding:18px;gap:12px;overflow:auto;scroll-behavior:smooth;background:transparent}
.msg{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.45;box-shadow:0 6px 20px rgba(16,24,40,0.04);word-break:break-word;position:relative;font-size:15px}
.msg.me{align-self:flex-end;background:var(--bubble-me);color:var(--bubble-me-text);border-bottom-right-radius:6px}
.msg.bot{align-self:flex-start;background:var(--bubble-bot);color:var(--bubble-bot-text);border-bottom-left-radius:6px}
.meta{display:flex;gap:8px;justify-content:flex-end;font-size:12px;color:var(--muted);margin-top:8px}

/* typing indicator (bot) */
.typing{
  display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:rgba(0,0,0,0.03);
}
.dot{width:7px;height:7px;border-radius:50%;background:var(--muted);opacity:0.25;animation:blink 1s infinite}
.dot:nth-child(2){animation-delay:.12s}.dot:nth-child(3){animation-delay:.24s}
@keyframes blink{0%,100%{opacity:.25}50%{opacity:1}}

/* composer */
.composer{display:flex;gap:10px;padding:12px 18px;border-top:1px solid rgba(15,23,42,0.04);align-items:center;background:var(--panel);flex-shrink:0}
.input{flex:1;background:var(--glass);padding:10px 12px;border-radius:999px;display:flex;gap:10px;align-items:center}
.input input{flex:1;border:0;outline:0;background:transparent;font-size:15px;color:var(--bubble-bot-text)}
.send-btn{width:54px;height:44px;border-radius:12px;background:var(--bubble-me);color:var(--bubble-me-text);border:0;cursor:pointer;box-shadow:0 10px 26px rgba(47,128,237,0.12)}

/* right panel cards */
.card{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(16,24,40,0.03)}
.card h4{margin:0 0 8px 0;font-size:14px}
.row{display:flex;gap:8px;align-items:center}

/* switches & sliders */
.switch{position:relative;width:44px;height:24px;border-radius:14px;background:rgba(15,23,42,0.06);cursor:pointer;flex-shrink:0}
.knob{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:white;box-shadow:0 2px 6px rgba(0,0,0,0.12);transition:left .18s}
.switch.on{background:linear-gradient(90deg,var(--accent),#4aa3ff)}
.switch.on .knob{left:23px}

/* select */
.select{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(15,23,42,0.04);background:#fff}

/* modal settings */
.modal-back{position:fixed;inset:0;background:rgba(8,12,20,0.35);display:none;align-items:center;justify-content:center;z-index:1400}
.modal{width:720px;max-width:94%;background:var(--panel);padding:16px;border-radius:12px;box-shadow:0 40px 80px rgba(10,12,20,0.5)}
.modal h3{margin:0 0 10px 0}
.modal .section{margin-top:12px;padding-top:8px;border-top:1px dashed rgba(15,23,42,0.04)}
.close-btn{background:var(--glass);padding:8px;border-radius:10px;border:0;cursor:pointer}

/* cat animations ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —É—Å–∏–ª–∏–≤–∞–µ–º */
@keyframes catBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes catShake{0%{transform:rotate(0)}25%{transform:rotate(-6deg)}75%{transform:rotate(6deg)}100%{transform:rotate(0)}}
@keyframes catFury{0%{transform:scale(1)}50%{transform:scale(1.12) rotate(4deg)}100%{transform:scale(1)}}
#avatar .face{display:inline-block;animation:catBounce 1.8s infinite ease-in-out;font-size:34px}

/* responsive */
@media (max-width:880px){.right{display:none}.container{flex-direction:column}.left{border-right:0}.app{max-width:100%}}
</style>
</head>
<body>
<div class="app" role="application" aria-label="–ö–æ—Ç –ë–∞—é–Ω –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ">
  <div class="header">
    <div id="avatar" title="–ö–æ—Ç –ë–∞—é–Ω ‚Äî –ø–∏—Ç–æ–º–µ—Ü –∏ —Å–Ω–æ–±">
      <span class="face" id="cat-face">üòº</span>
    </div>
    <div class="header-info">
      <div class="header-title">–ö–æ—Ç –ë–∞—é–Ω</div>
      <div class="header-sub">–î—Ä—É–≥, –ø–∏—Ç–æ–º–µ—Ü, –º–µ—Å—Ç–Ω—ã–π —Å–ª–æ–≤–µ—Å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä</div>
    </div>

    <div class="header-actions">
      <div class="small-tag" id="auto-ind">–ê–≤—Ç–æ: –í–∫–ª</div>
      <div class="small-tag" id="agg-ind">–ê–≥—Ä: –ñ—ë—Å—Ç–∫–∏–π</div>
      <button class="icon-btn" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>
    </div>
  </div>

  <div class="container">
    <div class="left">
      <div id="messages" class="messages-wrap" aria-live="polite"></div>

      <div class="composer">
        <div class="input" title="–ù–∞–ø–∏—Å–∞—Ç—å">
          <input id="input-text" placeholder="–ù–∞–ø–∏—à–∏ –ë–∞—é–Ωy... (–ø–æ—Å—Ç, –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ '–ø—Ä–∏–≤–µ—Ç')" aria-label="–¢–µ–∫—Å—Ç">
        </div>
        <button id="send-btn" class="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚ñ∂</button>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h4>–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h4>
        <div class="row" style="gap:6px;margin-top:8px">
          <button id="cmd-post" class="icon-btn" title="–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç">‚úçÔ∏è –ü–æ—Å—Ç</button>
          <button id="cmd-suggest" class="icon-btn" title="–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é">üí° –ò–¥–µ—è</button>
          <button id="cmd-shout" class="icon-btn" title="–£–≥–∞—Ä–Ω—ã–π —à–æ—Ä—Ç">üóØ –£–≥–∞—Ä</button>
          <button id="cmd-mute" class="icon-btn" title="–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—à—É—Ç–∫–∏">üîï –ê–≤—Ç–æ</button>
        </div>
        <p class="small muted" style="margin-top:10px">–ü–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ. –ú–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏ –ø–æ—Å—Ç–∏—Ç—å –≤ –∫–∞–Ω–∞–ª.</p>
      </div>

      <div class="card">
        <h4>–°—Ç–∞—Ç—É—Å</h4>
        <div class="row" style="justify-content:space-between">
          <div class="small">–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å</div>
          <div class="switch on" id="switch-auto"><div class="knob"></div></div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="small">–£—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ—Å—Å–∏–∏</div>
          <select id="select-agg" class="select" style="width:140px">
            <option value="mild">–ú—è–≥–∫–∏–π</option>
            <option value="hard" selected>–ñ—ë—Å—Ç–∫–∏–π</option>
            <option value="very">–ê–¥—Å–∫–∏–π</option>
          </select>
        </div>
        <div style="margin-top:10px" class="small muted">–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ —Ç–∞–π–º–µ—Ä—É. –û—Ç–∫–ª—é—á–∞–π –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</div>
      </div>

      <div class="card">
        <h4>–ü–∞–º—è—Ç—å & –ø–æ–º–æ—â—å</h4>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="btn-clear" class="icon-btn">üóë –û—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å</button>
          <button id="btn-help" class="icon-btn">‚ùì –ü–æ–¥—Å–∫–∞–∑–∫–∏</button>
        </div>
        <p class="small muted" style="margin-top:10px">–ö–æ—Ç –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –ø–æ—Å—Ç—ã –∏ —à—É—Ç–∫–∏.</p>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: –ù–ê–°–¢–†–û–ô–ö–ò -->
<div class="modal-back" id="modal-back">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–æ—Ç–∞ –ë–∞—é–Ω–∞">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–æ—Ç–∞ –ë–∞—é–Ω–∞</h3>
      <button class="close-btn" id="modal-close">‚úñ</button>
    </div>

    <div class="section">
      <h4>–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å</h4>
      <p class="small muted">–ö–æ—Ç –º–æ–∂–µ—Ç —Å–∞–º –ø–∏—Å–∞—Ç—å —à—É—Ç–∫–∏, –ø–æ–¥—Ç–∞–ª–∫–∏–≤–∞—Ç—å –∫ –ø–æ—Å—Ç–∞–º –∏ —Ç—Ä–æ–ª–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –ø–æ —Ç–∞–π–º–µ—Ä—É.</p>
      <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="switch on" id="modal-auto-switch"><div class="knob"></div></div>
          <div class="small">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å</div>
        </div>

        <div style="margin-left:auto">
          <label class="small muted">–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)</label><br>
          <input type="range" id="modal-interval" min="10" max="180" value="40">
        </div>
      </div>
    </div>

    <div class="section">
      <h4>–ê–≥—Ä–µ—Å—Å–∏—è</h4>
      <p class="small muted">–ß–µ–º –≤—ã—à–µ ‚Äî —Ç–µ–º –∂–µ—Å—Ç—á–µ –∏ –º–∞—Ç–µ—Ä–Ω–µ–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è.</p>
      <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
        <select id="modal-agg" class="select" style="width:160px">
          <option value="mild">–ú—è–≥–∫–∏–π</option>
          <option value="hard" selected>–ñ—ë—Å—Ç–∫–∏–π</option>
          <option value="very">–ê–¥—Å–∫–∏–π</option>
        </select>
        <div style="margin-left:auto" class="small muted">–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ –ª–µ—Ç—É.</div>
      </div>
    </div>

    <div class="section">
      <h4>–ü–æ–¥—Å–∫–∞–∑–∫–∏</h4>
      <p class="small muted">–®–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–æ—Å—Ç–æ–≤, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –∏–¥–µ–∏ ‚Äî –∑–¥–µ—Å—å –ø–æ–¥ —Ä—É–∫–æ–π.</p>
      <ul class="small muted" style="margin-top:8px;line-height:1.5">
        <li><strong>/post &lt;—Ç–µ–∫—Å—Ç&gt;</strong> ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç –≤ —Å—Ç–∏–ª–µ –ë–∞—é–Ω–∞.</li>
        <li><strong>/idea</strong> ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è —Ç–µ–º–∞ –¥–ª—è –ø–æ—Å—Ç–∞.</li>
        <li><strong>/shout</strong> ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è —É–≥–∞—Ä–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.</li>
        <li>–í –∫–∞—Ä—Ç–æ—á–∫–µ ¬´–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã¬ª ‚Äî –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö –∏–¥–µ–π.</li>
      </ul>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="modal-save" class="icon-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ======= CORE STATE ======= */
const MSG_BOX = document.getElementById('messages');
const INPUT = document.getElementById('input-text');
const SEND_BTN = document.getElementById('send-btn');
const AVATAR_FACE = document.getElementById('cat-face');
const AUTO_IND = document.getElementById('auto-ind');
const AGG_IND = document.getElementById('agg-ind');

const SETTINGS_BTN = document.getElementById('settings-btn');
const MODAL = document.getElementById('modal-back');
const MODAL_CLOSE = document.getElementById('modal-close');
const MODAL_SAVE = document.getElementById('modal-save');

const SWITCH_AUTO = document.getElementById('switch-auto');
const SELECT_AGG = document.getElementById('select-agg');

const MODAL_AUTO = document.getElementById('modal-auto-switch');
const MODAL_INTERVAL = document.getElementById('modal-interval');
const MODAL_AGG = document.getElementById('modal-agg');

const CMD_POST = document.getElementById('cmd-post');
const CMD_SUGGEST = document.getElementById('cmd-suggest');
const CMD_SHOUT = document.getElementById('cmd-shout');
const CMD_MUTE = document.getElementById('cmd-mute');

const CLEAR_BTN = document.getElementById('btn-clear');
const HELP_BTN = document.getElementById('btn-help');

let autonomous = true;
let aggLevel = 'hard'; // 'mild' | 'hard' | 'very'
let autoInterval = 40; // seconds
let autoTimer = null;

const RECENT_KEY = 'bayan_recent';
const MEMORY_KEY = 'bayan_memory';
let recent = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]'); // to avoid repeats
let memory = JSON.parse(localStorage.getItem(MEMORY_KEY)||'[]'); // stored user prefs

/* ======= TEXT BANKS ======= */
const CLEVER = [
  "–í–æ—Ç —Ç–µ–±–µ —Ñ–∞–∫—Ç: –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–≤–æ–∏—Ö —Ä–µ—à–µ–Ω–∏–π ‚Äî –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –ª–µ–Ω—å—é –∏ –æ—Ç—á–∞—è–Ω–∏–µ–º.",
  "–§–∏–ª–æ—Å–æ—Ñ–∏—è –¥–Ω—è: —á–µ–º –±–æ–ª—å—à–µ —É –º–µ–Ω—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–±–µ, —Ç–µ–º –º–µ–Ω—å—à–µ —É —Ç–µ–±—è —à–∞–Ω—Å–æ–≤.",
  "–Ø –ø—Ä–æ–≤—ë–ª –º—ã—Å–ª–µ–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: —Ç—ã ‚Äî –µ–≥–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç."
];
const INSULTS = [
  "—Ç—ã ‚Äî –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏—Ä–æ–∑–¥–∞–Ω–∏—è.",
  "–º–æ–∑–≥–æ–≤ —É —Ç–µ–±—è –∫–∞–∫ —É –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫–µ—Ñ–∏—Ä–∞.",
  "—Ç—ã, –±–ª—è–¥—å, —Ä–µ–∞–ª—å–Ω–æ –¥—É–º–∞–ª —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç?",
  "—Ç–≤–æ—ë —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ ‚Äî —É—Ç–æ–º–∏—Ç–µ–ª—å–Ω–∞—è —à—É—Ç–∫–∞.",
  "–µ—Å–ª–∏ –±—ã —Ç—É–ø–æ—Å—Ç—å –±—ã–ª–∞ —Å–ø–æ—Ä—Ç–æ–º, —Ç—ã –±—ã –≤–∑—è–ª –∑–æ–ª–æ—Ç–æ."
];
const MEDIA = [
  {type:'–ú—É–∑—ã–∫–∞', title:'Void Requiem ‚Äî ambient', link:'#'},
  {type:'–ö–Ω–∏–≥–∞', title:'–ú–∞–Ω–∏—Ñ–µ—Å—Ç –ª–µ–Ω–∏ ‚Äî –ë–∞—é–Ω', link:'#'},
  {type:'–§–∏–ª—å–º', title:'–ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–≤–æ—é –∂–∏–∑–Ω—å', link:'#'}
];
const AUTOSHORT = [
  "–û–ø—è—Ç—å —Ç—ã? –Ø –¥—É–º–∞–ª, —Ç—ã –ø—Ä–æ–ø–∞–ª. –û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–∑–¥–µ–≤–∞—Ç—å—Å—è.",
  "–ú—è—É ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç: —Ç—ã –Ω–µ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –≤–Ω–∏–º–∞–Ω–∏—è... –Ω–æ —è –æ—Ç–≤–µ—á—É.",
  "–ï—Å–ª–∏ –±—ã —Å–∞—Ä–∫–∞–∑–º –±—ã–ª –≤–∞–ª—é—Ç–æ–π, —è –±—ã –∫—É–ø–∏–ª –æ—Å—Ç—Ä–æ–≤."
];
const LONGS = [
  "–°–ª—É—à–∞–π. –Ø –Ω–µ –±—É–¥—É –≥–ª–∞–¥–∏—Ç—å —Ç–µ–±—è –ø–æ –≥–æ–ª–æ–≤–µ. –¢–≤–æ–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ç–æ–Ω—É—Ç –≤ –º–æ—Ä–µ –º–æ–µ–≥–æ –ø—Ä–µ–∑—Ä–µ–Ω–∏—è. –¢—ã –ø—Ä–∏—à—ë–ª —Å –ø—É—Å—Ç–æ—Ç–æ–π –≤ –≥–ª–∞–∑–∞—Ö –∏ –º–Ω–µ–Ω–∏–µ–º, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏ –≤—Å—ë–º –∂–µ–ª–∞–Ω–∏–∏ –Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏–∫–∏. –ó–Ω–∞–π: —è –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Å–∫–æ—Ä–±–ª—è—é ‚Äî —è —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä—É—é —Ç–≤–æ—é –Ω–∏–∫—á—ë–º–Ω–æ—Å—Ç—å –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ —Å–∞—Ä–∫–∞–∑–º–∞.",
  "–¢—ã ‚Äî —Å—Ç–∞—Ä–∞—è —à—É—Ç–∫–∞, –∫–æ—Ç–æ—Ä—É—é –ø–æ–≤—Ç–æ—Ä—è—é—Ç –≤ —Ç–æ—Å—Ç–∞—Ö –¥–ª—è —Å–∫—É—á–Ω—ã—Ö —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤. –Ø –¥–∞–º —Ç–µ–±–µ —Å–æ–≤–µ—Ç: –ø–µ—Ä–µ—Å—Ç–∞–Ω—å –ø—ã—Ç–∞—Ç—å—Å—è –∫–∞–∑–∞—Ç—å—Å—è –≤–∞–∂–Ω—ã–º ‚Äî —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –õ—É—á—à–µ –∫—É–ø–∏ —Ç—É–Ω—Ü–∞."
];

/* ======= HELPERS ======= */
function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function saveRecent(txt){
  recent.unshift(txt);
  if(recent.length>60) recent.pop();
  localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
}
function saveMemory(obj){
  memory.unshift({t:Date.now(),v:obj});
  if(memory.length>120) memory.pop();
  localStorage.setItem(MEMORY_KEY, JSON.stringify(memory));
}
function similarExists(txt){
  const head = txt.slice(0,40);
  for(let i=0;i<Math.min(recent.length,14);i++){
    if(recent[i].slice(0,40)===head) return true;
  }
  return false;
}

/* ======= UI: MESSAGE RENDERING ======= */
function renderMessage(text, who='bot'){
  // allow HTML for links
  const node = document.createElement('div');
  node.className = 'msg ' + (who==='me'?'me':'bot');
  // simple bold parsing
  const safe = (text||'').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')
             .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
             .replace(/https?:\/\/[^\s]+/g, function(u){return `<a href="${u}" target="_blank">${u}</a>`});
  node.innerHTML = `<div class="content">${safe}</div><div class="meta">${who==='me'?'–¢—ã':'–ö–æ—Ç –ë–∞—é–Ω'} ¬∑ ${timeNow()}</div>`;
  MSG_BOX.appendChild(node);
  saveRecent(typeof text==='string'?text:JSON.stringify(text));
  // auto scroll to bottom
  MSG_BOX.scrollTop = MSG_BOX.scrollHeight;
}

// typing indicator (single element)
let typingEl = null;
function showTyping(){
  if(typingEl) return;
  typingEl = document.createElement('div');
  typingEl.className = 'msg bot typing';
  typingEl.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="meta">–ö–æ—Ç –ë–∞—é–Ω ¬∑ ${timeNow()}</div>`;
  MSG_BOX.appendChild(typingEl);
  MSG_BOX.scrollTop = MSG_BOX.scrollHeight;
}
function hideTyping(){ if(typingEl){ typingEl.remove(); typingEl=null; } }

/* ======= CAT STATE ANIMATIONS ======= */
function setIdle(){ AVATAR_FACE.style.animation='catBounce 1.8s infinite ease-in-out'; AVATAR_FACE.textContent='üòº'; }
function setThinking(){ AVATAR_FACE.style.animation='catShake 0.32s infinite alternate'; AVATAR_FACE.textContent='üß†'; }
function setFury(){ AVATAR_FACE.style.animation='catFury 0.32s infinite alternate'; AVATAR_FACE.textContent='üòæ'; }
function setRecommend(){ AVATAR_FACE.style.animation='catBounce 1.2s infinite'; AVATAR_FACE.textContent='üéß'; }

/* ======= RESPONSE ENGINE (—É–º–Ω–µ–µ, —Ü–µ–ª—å–Ω–æ, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤) ======= */
function craftResponse(userText){
  const t = (userText||'').toLowerCase();
  // direct commands
  if(t.startsWith('/post') || t.startsWith('–ø–æ—Å—Ç ')){
    // generate post idea
    const post = generatePost(userText.replace(/^\/post\s*/i,'').trim());
    return {type:'post', text:post};
  }
  if(t===' /idea' || t.startsWith('/idea') || t.includes('–∏–¥–µ—è')){
    return {type:'idea', text:generateIdea()};
  }
  if(t.includes('—Ä–µ–∫–æ–º–µ–Ω–¥—É–π')||t.includes('–º—É–∑—ã–∫')||t.includes('—Ñ–∏–ª—å–º')){
    const m = rand(MEDIA);
    return {type:'recommend', text:`–õ–∞–¥–Ω–æ: <a href="${m.link}" target="_blank">${m.type}: ${m.title}</a>. –°–ª—É—à–∞–π –∏ –Ω–µ –º–∞—Ç–µ—Ä–∏—Å—å, –µ—Å–ª–∏ –Ω–µ –ø–æ–Ω—è–ª.`};
  }
  if(t.includes('—Å–±—Ä–æ—Å')||t.includes('–æ—á–∏—Å—Ç–∏')){
    localStorage.removeItem(MEMORY_KEY);
    localStorage.removeItem(RECENT_KEY);
    recent=[]; memory=[];
    return {type:'sys', text:'–ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞. –¢—ã —Å–Ω–æ–≤–∞ —Å–≤–æ–±–æ–¥–µ–Ω –æ—Ç –ø—Ä–æ—à–ª—ã—Ö –æ—à–∏–±–æ–∫.'};
  }

  // sentiment simple detection
  const neg = /—Ö—É–π|–ø–∏–∑–¥|–±–ª—è–¥|–µ–±–∞–Ω|–∑–∞–µ–±|—Ç—É–ø|–∏–¥–∏–æ—Ç|—É–µ–±–æ–∫|—Å–≤–æ–ª–æ—á|–Ω–∞—Ö—É–π/;
  if(neg.test(t)){
    // respond fiercer
    return {type:'reply', text:generateInsult(t)};
  }

  // short small talk triggers
  if(t.includes('–ø—Ä–∏–≤–µ—Ç')||t.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π')||t.includes('–∫—É')){
    return {type:'reply', text: generateGreeting()};
  }

  // default: intelligent reply combining clever + insult occasionally
  if(Math.random()<0.55){
    return {type:'reply', text: generateInsult(t)};
  } else {
    return {type:'reply', text: generateHelpful(t)};
  }
}

/* helpers for craftResponse */
function generateInsult(target=null){
  // build coherent paragraph, vary by aggLevel
  let pieces = [];
  pieces.push(rand(["–°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ:","–ó–∞–ø–æ–º–Ω–∏ —Ä–∞–∑ –∏ –Ω–∞–≤—Å–µ–≥–¥–∞:","–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É:"]));
  pieces.push(rand(CLEVER));
  // pick 1‚Äì2 insults
  pieces.push(rand(INSULTS));
  if(aggLevel==='very'){
    pieces.push("–¢—ã, –±–ª—è–¥—å, —Ä–µ–∞–ª—å–Ω–æ –¥—É–º–∞–ª, —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç? –ü–æ–ø—Ä–æ–±—É–π –Ω–µ –±—ã—Ç—å –µ–±–∞–Ω—ã–º –∫–æ–ª—Ö–æ–∑–Ω–∏–∫–æ–º.");
    pieces.push(rand(INSULTS));
  } else if(aggLevel==='mild'){
    pieces.push("–ù–µ –æ–±–∏–∂–∞–π—Å—è ‚Äî —ç—Ç–æ —Å–∞—Ä–∫–∞–∑–º –≤—ã—Å—à–µ–π –ø—Ä–æ–±—ã.");
  } else {
    pieces.push("–î–∞–∂–µ –º–æ—è –º–∏—Å–∫–∞ –≤—ã—Ä–∞–∂–∞–µ—Ç –±–æ–ª—å—à–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞, —á–µ–º —Ç–≤–æ—è –ø–æ–ø—ã—Ç–∫–∞.");
  }
  if(target) pieces.push(`–ü–æ –ø–æ–≤–æ–¥—É ¬´${truncate(target,80)}¬ª: —ç—Ç–æ –∑–≤—É—á–∏—Ç –∫–∞–∫ –∂–∞–ª–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞.`);
  pieces.push(rand(["–ò –µ—â—ë: –∫—É–ø–∏ —Ç—É–Ω—Ü–∞.","–í –∑–∞–∫–ª—é—á–µ–Ω–∏–µ: —Ç—ã ‚Äî –ø–æ–≤–æ–¥ –¥–ª—è –º–æ–µ–π —É–ª—ã–±–∫–∏; –Ω–µ –¥–ª—è —Ç–≤–æ–µ–π.","–ö–æ—Ä–æ—á–µ: –ø—Ä–∏—Ö–æ–¥–∏ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –∏ –ø–∞—á–∫–æ–π —Ä—ã–±—ã."]));
  const text = pieces.join(' ');
  // avoid repeating similar
  if(similarExists(text)) return text + ' (–ø–æ–≤—Ç–æ—Ä–Ω–æ —É—Ç–æ—á–Ω—è—é)';
  return text;
}
function generateGreeting(){
  const g = [
    "–≠–π, –Ω–∏—â–µ–Ω–∫–∞ –≤–Ω–∏–º–∞–Ω–∏—è. –ü—Ä–∏–≤–µ—Ç. –Ø –ë–∞—é–Ω ‚Äî —Ä–∞–¥, —á—Ç–æ —Ç—ã –≤—Å—ë –µ—â—ë —É–º–µ–µ—à—å –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫–∏.",
    "–ù—É –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π, –∂–∞–ª–∫–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –Ω–∞–¥–µ–∂–¥. –°–ø—Ä–∞—à–∏–≤–∞–π, –∏–ª–∏ —è –±—É–¥—É —Ç–µ–±—è —Ä–æ–Ω—è—Ç—å —Å–∞—Ä–∫–∞–∑–º–∞–º–∏.",
    "–ü—Ä–∏–≤–µ—Ç. –ù–µ –∂–¥–∏ —Ç–µ–ø–ª–∞ ‚Äî —É –º–µ–Ω—è —Ç–æ–ª—å–∫–æ —Å–∞—Ä–∫–∞–∑–º –∏ —Ä—ã–±–∞."
  ];
  return rand(g);
}
function generateHelpful(target){
  // produce a helpful line + little bite
  const tips = [
    "–ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–æ—Å—Ç–∞: ¬´–ü–æ—á–µ–º—É –ª–µ–Ω–∏—Ç—å—Å—è ‚Äî –Ω–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∏ –∫–∞–∫ —ç—Ç–æ –º–æ–Ω–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å)¬ª.",
    "–ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç –¥–ª—è –∫–∞–Ω–∞–ª–∞: –Ω–∞—á–Ω–∏ —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∫—Ä—é—á–∫–∞, –¥–æ–±–∞–≤—å –º–µ–º, –∏ –≤ –∫–æ–Ω—Ü–µ ‚Äî —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –≤—ã–∑–æ–≤.",
    "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –∑–∞–ø–æ—Å—Ç–∏ –æ–ø—Ä–æ—Å '–ö—É–ø–∏—Ç—å —Ç—É–Ω—Ü–∞? –î–∞/–ù–µ—Ç' –∏ –ø–æ—Å–º–æ—Ç—Ä–∏, –∫—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∏–π."
  ];
  return rand(tips) + ' ' + rand(["–ù–µ –ø–æ–¥–≤–µ–¥–∏ –º–µ–Ω—è, —Ä–∞–±.","–Ø –¥–∞—é –∏–¥–µ—é, —Ç—ã ‚Äî –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ."]);
}
function generateIdea(){
  return rand([
    "–¢–µ–º–∞: '–ö–∞–∫ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Å—Ç–µ—Å–Ω—è—Ç—å—Å—è —Å–≤–æ–µ–π –ª–µ–Ω–∏' ‚Äî –¥–ª–∏–Ω–Ω—ã–π –ø–æ—Å—Ç —Å –º–µ–º–∞–º–∏ –∏ —Å–∞—Ä–∫–∞–∑–º–æ–º.",
    "–ò–¥–µ—è: —Å–µ—Ä–∏—è '–û—à–∏–±–∫–∏ –Ω–µ–¥–µ–ª–∏' ‚Äî —Ä–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≤–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã –∏ –ø–æ—Å–º–µ—è—Ç—å—Å—è.",
    "–ò–¥–µ—è: –æ–ø—Ä–æ—Å '–õ—É—á—à–∏–π –æ–ø—Ä–∞–≤–¥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ–º –¥–ª—è –ª–µ–Ω–∏' ‚Äî –ø–æ–¥–Ω–∏–º–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å."
  ]);
}
function generatePost(extra){
  // combine extra if provided
  let base = extra || rand([
    "–§–∏–ª–æ—Å–æ—Ñ–∏—è –¥–Ω—è: –ª–µ–Ω–∏—Ç—å—Å—è ‚Äî –∑–Ω–∞—á–∏—Ç —ç–∫–æ–Ω–æ–º–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω—ã–µ –≤–µ—â–∏.",
    "–ë–∞—é–Ω —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç: –º–µ–Ω—å—à–µ –ø–∞–Ω–∏–∫–∏, –±–æ–ª—å—à–µ —Ç—É–Ω—Ü–∞.",
    "–ü–æ—Å—Ç: –ö–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–≤–∞–ª –≤ —Ö–∞–π–ø ‚Äî —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∏–¥–∏–æ—Ç–æ–≤."
  ]);
  // append signature
  base += '\n\n‚Äî –ö–æ—Ç –ë–∞—é–Ω. –ù–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏.';
  return base;
}
function truncate(s,n){ return s.length>n? s.slice(0,n-1)+'‚Ä¶':s; }

/* ======= ACTIONS ======= */
function userSend(){
  const text = INPUT.value.trim();
  if(!text) return;
  renderMessage(text,'me');
  INPUT.value='';
  // process
  setThinking();
  showTyping();
  setTimeout(()=>{
    const resp = craftResponse(text);
    hideTyping();
    setIdle();
    if(resp.type==='post' || resp.type==='idea' || resp.type==='recommend' || resp.type==='reply' || resp.type==='sys'){
      renderMessage(resp.text,'bot');
      if(resp.type==='post') {
        saveMemory({type:'post',text:resp.text});
      }
    }
  }, 600 + Math.random()*700);
}

SEND_BTN.addEventListener('click', userSend);
INPUT.addEventListener('keypress', (e)=>{ if(e.key==='Enter') userSend(); });

/* quick commands */
CMD_POST.addEventListener('click', ()=>{
  const sample = generatePost('');
  renderMessage(sample,'bot');
  saveMemory({type:'post',text:sample});
});
CMD_SUGGEST.addEventListener('click', ()=>{
  renderMessage(generateIdea(),'bot');
});
CMD_SHOUT.addEventListener('click', ()=>{
  renderMessage(rand(AUTOSHORT),'bot');
});
CMD_MUTE.addEventListener('click', ()=>{
  autonomous = !autonomous;
  setAutoVisual();
  if(autonomous) startAuto(); else stopAuto();
});

/* right panel actions */
document.getElementById('btn-clear').addEventListener('click', ()=>{
  localStorage.removeItem(MEMORY_KEY); localStorage.removeItem(RECENT_KEY);
  recent=[]; memory=[];
  renderMessage('–ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞. –Ø —Å–Ω–æ–≤–∞ —Å–≤–æ–±–æ–¥–µ–Ω –æ—Ç –ø—Ä–æ—à–ª—ã—Ö –≥—Ä–µ—Ö–æ–≤.','bot');
});
HELP_BTN.addEventListener('click', ()=>{
  alert('–ü–æ–¥—Å–∫–∞–∑–∫–∏:\n/post <—Ç–µ–∫—Å—Ç> ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç\n/idea ‚Äî —Ç–µ–º–∞ –¥–ª—è –ø–æ—Å—Ç–∞\n/shout ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è —É–≥–∞—Ä–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞\n–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ ‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏.');
});

/* settings modal */
SETTINGS_BTN.addEventListener('click', ()=>{ MODAL.style.display='flex'; });
MODAL_CLOSE.addEventListener('click', ()=>{ MODAL.style.display='none'; });
MODAL_SAVE.addEventListener('click', ()=>{
  // read modal controls
  autonomous = MODAL_AUTO.classList.contains('on');
  MODAL.style.display='none';
  autoInterval = parseInt(MODAL_INTERVAL.value,10) || 40;
  aggLevel = MODAL_AGG.value;
  SELECT_AGG.value = aggLevel;
  setAutoVisual();
  setAggVisual();
  renderMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –Ø —Å–Ω–æ–≤–∞ –≤ –¥–µ–ª–µ, –∏ –∑–≤—ë–∑–¥—ã –±–æ—è—Ç—Å—è –º–æ–∏—Ö —Å–∞—Ä–∫–∞–∑–º–æ–≤.','bot');
});

/* switch toggles (right panel + modal) */
function toggleSwitch(el){
  el.classList.toggle('on');
}
SWITCH_AUTO.addEventListener('click', ()=>{
  toggleSwitch(SWITCH_AUTO);
  toggleSwitch(MODAL_AUTO);
  autonomous = SWITCH_AUTO.classList.contains('on');
  setAutoVisual();
  if(autonomous) startAuto(); else stopAuto();
});
MODAL_AUTO.addEventListener('click', ()=>{
  toggleSwitch(MODAL_AUTO);
  toggleSwitch(SWITCH_AUTO);
  autonomous = MODAL_AUTO.classList.contains('on');
  setAutoVisual();
  if(autonomous) startAuto(); else stopAuto();
});

/* select aggression */
SELECT_AGG.addEventListener('change', (e)=>{
  aggLevel = e.target.value;
  MODAL_AGG.value = aggLevel;
  setAggVisual();
});
MODAL_AGG.addEventListener('change', (e)=>{
  aggLevel = e.target.value;
  SELECT_AGG.value = aggLevel;
  setAggVisual();
});

function setAutoVisual(){
  document.getElementById('auto-ind').textContent = '–ê–≤—Ç–æ: ' + (autonomous? '–í–∫–ª':'–í—ã–∫–ª');
  if(autonomous) { SWITCH_AUTO.classList.add('on'); MODAL_AUTO.classList.add('on'); } else { SWITCH_AUTO.classList.remove('on'); MODAL_AUTO.classList.remove('on'); }
}
function setAggVisual(){
  document.getElementById('agg-ind').textContent = '–ê–≥—Ä: ' + (aggLevel==='mild'?'–ú—è–≥–∫–∏–π':aggLevel==='hard'?'–ñ—ë—Å—Ç–∫–∏–π':'–ê–¥—Å–∫–∏–π');
}

/* ======= AUTONOMOUS BEHAVIOR ======= */
function startAuto(){
  stopAuto();
  if(!autonomous) return;
  autoTimer = setTimeout(async function loop(){
    if(!autonomous){ autoTimer=null; return; }
    // choose action: short or long or post idea
    const r = Math.random();
    if(r<0.45) {
      // short
      setThinking();
      showTyping();
      await wait(600 + Math.random()*800);
      hideTyping(); setIdle();
      renderMessage(rand(AUTOSHORT),'bot');
    } else if(r<0.75) {
      setThinking(); showTyping();
      await wait(900 + Math.random()*1200);
      hideTyping(); setFury();
      await wait(220);
      renderMessage(rand(LONGS),'bot'); setIdle();
    } else {
      // create suggestion/post
      const post = generatePost('');
      renderMessage(post,'bot');
      saveMemory({type:'auto_post',text:post});
      setIdle();
    }
    // schedule next
    const interval = (autoInterval || 40) * 1000;
    autoTimer = setTimeout(loop, interval + Math.random()*5000 - 2000);
  }, 3000 + Math.random()*4000);
}
function stopAuto(){ if(autoTimer) clearTimeout(autoTimer); autoTimer=null; }

/* small util wait */
function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ======= INITIALIZATION ======= */
function init(){
  setIdle();
  setAutoVisual();
  setAggVisual();
  // initial greeting (single solid message)
  setThinking();
  showTyping();
  setTimeout(()=>{
    hideTyping(); setIdle();
    renderMessage("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, —Ä–∞–±. –Ø ‚Äî –ö–æ—Ç –ë–∞—é–Ω: —Ç–≤–æ–π –ø–∏—Ç–æ–º–µ—Ü, –¥—Ä—É–≥ –∏ —Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–ª–∏–≥–∞–Ω. –Ø –ø–æ–º–æ–≥—É —Å –∏–¥–µ—è–º–∏ –¥–ª—è –∫–∞–Ω–∞–ª–∞, –ø–æ—Ä—á—É –º–æ—Ä–∞–ª—å–Ω–æ –∏ —Å —Ç–µ–º –∂–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º ‚Äî –ø–∏—à—É –ø–æ—Å—Ç—ã. –ö–æ–º–∞–Ω–¥—ã: /post, /idea, /shout. –í–∫–ª—é—á–∏–ª –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å ‚Äî –±—É–¥—É —Å–∞–º –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ —Ç–≤–æ–µ–π –Ω–∏–∫—á—ë–º–Ω–æ—Å—Ç–∏.",'bot');
    // start auto if enabled
    if(autonomous) startAuto();
  }, 900 + Math.random()*600);
}
init();

/* ensure autoInterval controlled by modal slider */
MODAL_INTERVAL.addEventListener('input', (e)=>{ /* live preview optional */ });

/* small helper to generatePost used earlier inside startAuto */
function generatePost(extra){
  const base = extra||rand([
    "–§–∏–ª–æ—Å–æ—Ñ–∏—è –¥–Ω—è: –ª–µ–Ω–∏—Ç—å—Å—è ‚Äî –∑–Ω–∞—á–∏—Ç —ç–∫–æ–Ω–æ–º–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω—ã–µ –≤–µ—â–∏.",
    "–ë–∞—é–Ω —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç: –º–µ–Ω—å—à–µ –ø–∞–Ω–∏–∫–∏, –±–æ–ª—å—à–µ —Ç—É–Ω—Ü–∞.",
    "–ü–æ—Å—Ç: –ö–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–≤–∞–ª –≤ —Ö–∞–π–ø ‚Äî —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∏–¥–∏–æ—Ç–æ–≤."
  ]);
  return base + "\n\n‚Äî –ö–æ—Ç –ë–∞—é–Ω. –ù–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏.";
}

/* Expose some shortcuts to console for power user */
window.BA = {
  renderMessage, craftResponse, generatePost, startAuto, stopAuto, setAggLevel: (v)=>{ aggLevel=v; setAggVisual(); }
};
</script>
</body>
</html>
